{% extends "base.html" %}
{% block title %}{{ mission.title if mission else "Mission" }}{% endblock %}

{% block content %}
<div class="mission-container">
    {% if error %}
        <h2>{{ error }}</h2>
        <a href="{{ url_for('game') }}" class="back-btn">Back to Map</a>
    {% else %}
        <h1>{{ mission.title }}</h1>
        <div id="mission-timer" class="mission-timer-bar">
            Time Left: <span id="timer-value"></span>
        </div>
        <h3>Objectives:</h3>
        <ul class="objectives-list" id="objectives-list">
            {% for obj in mission.objectives %}
            <li data-index="{{ loop.index0 }}" {% if loop.index0 in completed_objectives %}class="completed"{% endif %}>
                <span class="objective-status {% if loop.index0 in completed_objectives %}completed{% endif %}">
                    [{{ '✓' if loop.index0 in completed_objectives else ' ' }}]
                </span> {{ obj }}
            </li>
            {% endfor %}
        </ul>
        {% if mission.tools_available %}
        <h3>Available Tools:</h3>
        <div class="tools-list" style="display: flex; gap: 18px; margin-bottom: 20px;">
            {% if 'Network Scanner' in mission.tools_available %}
            <button class="tool-btn" data-tool="network-scanner">Network Scanner</button>
            {% endif %}
            {% if 'Log Analyzer' in mission.tools_available %}
            <button class="tool-btn" data-tool="log-analyzer">Log Analyzer</button>
            {% endif %}
            {% if 'Password Cracker' in mission.tools_available %}
            <button class="tool-btn" data-tool="password-cracker">Password Cracker</button>
            {% endif %}
            {% if 'File Recovery' in mission.tools_available %}
            <button class="tool-btn" data-tool="file-recovery">File Recovery</button>
            {% endif %}
        </div>
        <div id="tool-interfaces">
            {% if 'Network Scanner' in mission.tools_available %}
            <div class="tool-interface" id="network-scanner-interface" style="display: none;">
                <h4>Network Scanner</h4>
                <div class="tool-controls">
                    <button class="tool-action-btn" id="start-scan">Start Scan</button>
                    <button class="tool-action-btn" id="stop-scan" disabled>Stop</button>
                </div>
                <div class="tool-content">
                    <div class="scan-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="scan-status">Ready to scan</div>
                    </div>
                    <div class="scan-results">
                        <pre id="scan-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if 'Log Analyzer' in mission.tools_available %}
            <div class="tool-interface" id="log-analyzer-interface" style="display: none;">
                <h4>Log Analyzer</h4>
                <div class="tool-controls">
                    <select id="log-type">
                        <option value="system">System Logs</option>
                        <option value="security">Security Logs</option>
                        <option value="application">Application Logs</option>
                    </select>
                    <button class="tool-action-btn" id="analyze-logs">Analyze</button>
                </div>
                <div class="tool-content">
                    <div class="log-filters">
                        <input type="text" id="log-search" placeholder="Search logs...">
                        <input type="datetime-local" id="log-time-start">
                        <input type="datetime-local" id="log-time-end">
                    </div>
                    <div class="log-results">
                        <pre id="log-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if 'Password Cracker' in mission.tools_available %}
            <div class="tool-interface" id="password-cracker-interface" style="display: none;">
                <h4>Password Cracker</h4>
                <div class="tool-controls">
                    <input type="text" id="hash-input" placeholder="Enter hash...">
                    <button class="tool-action-btn" id="crack-hash">Crack</button>
                </div>
                <div class="tool-content">
                    <div class="crack-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="crack-status">Ready</div>
                    </div>
                    <div class="crack-results">
                        <pre id="crack-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if 'File Recovery' in mission.tools_available %}
            <div class="tool-interface" id="file-recovery-interface" style="display: none;">
                <h4>File Recovery</h4>
                <div class="tool-controls">
                    <input type="text" id="file-path" placeholder="Enter file path...">
                    <button class="tool-action-btn" id="recover-file">Recover</button>
                </div>
                <div class="tool-content">
                    <div class="recovery-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="recovery-status">Ready</div>
                    </div>
                    <div class="recovery-results">
                        <pre id="recovery-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        <h3>NPC Dialogue:</h3>
        <div class="npc-dialogue-area">
            <div id="dialogue-text"></div>
            <div id="options"></div>
        </div>
        <a href="{{ url_for('game') }}" class="back-btn">Back to Map</a>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
window.completedObjectives = JSON.parse('{{ completed_objectives|tojson|safe }}');
window.totalObjectives = parseInt('{{ mission.objectives|length }}');
window.missionLocation = "{{ location }}";
// Timer
let timeLeft = parseInt('{{ mission.timeLimit if mission and mission.timeLimit else 1800 }}');
function updateTimer() {
    const timerValue = document.getElementById('timer-value');
    if (!timerValue) return;
    let min = Math.floor(timeLeft / 60);
    let sec = timeLeft % 60;
    timerValue.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    if (timeLeft > 0) {
        timeLeft--;
        setTimeout(updateTimer, 1000);
    } else {
        document.getElementById('mission-timer').textContent = "Mission Failed!";
    }
}
if (document.getElementById('timer-value')) updateTimer();
// Toast/markObjective/saveObjectives globally
window.markObjectiveComplete = function(index) {
    if (!window.completedObjectives.includes(index)) {
        window.completedObjectives.push(index);
        window.saveObjectives();
        const objList = document.getElementById('objectives-list');
        if (objList) {
            const li = objList.querySelector(`li[data-index="${index}"]`);
            if (li) {
                li.querySelector('.objective-status').textContent = '[✓]';
                li.querySelector('.objective-status').style.color = '#38d39f';
                li.classList.add('completed');
                showObjectiveToast("Objective completed!");
            }
        }
        if (window.completedObjectives.length === window.totalObjectives) {
            showObjectiveToast("All objectives completed!");
        }
    }
};
window.showObjectiveToast = function(msg) {
    let toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '28px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#232323';
    toast.style.color = '#38d39f';
    toast.style.padding = '12px 24px';
    toast.style.borderRadius = '12px';
    toast.style.zIndex = 9999;
    toast.style.fontSize = '1.1em';
    toast.style.boxShadow = '0 2px 16px #0008';
    document.body.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 1500);
};
window.saveObjectives = function() {
    fetch(window.location.pathname, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({completed: window.completedObjectives})
    });
};
// Tools tab switching
document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tool-interface').forEach(div => div.style.display = 'none');
        const toolId = btn.getAttribute('data-tool');
        const interfaceDiv = document.getElementById(`${toolId}-interface`);
        if (interfaceDiv) interfaceDiv.style.display = 'block';
    });
});
</script>
<script src="{{ url_for('static', filename='js/tools.js') }}"></script>
<script src="{{ url_for('static', filename='js/dialogues.js') }}"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mission.css') }}">
{% endblock %}
