{% extends "base.html" %}
{% block title %}{{ mission.title if mission else "Mission" }}{% endblock %}

{% block content %}
<div class="mission-container">
    {% if error %}
        <h2>{{ error }}</h2>
        <a href="{{ url_for('game') }}" class="back-btn">Back to Map</a>
    {% else %}
        <h1>{{ mission.title }}</h1>
        <div id="mission-timer" class="mission-timer-bar">
            Time Left: <span id="timer-value"></span>
        </div>
        <h3>Objectives:</h3>
        <ul class="objectives-list" id="objectives-list">
            {% for obj in mission.objectives %}
            <li data-index="{{ loop.index0 }}" {% if loop.index0 in completed_objectives %}class="completed"{% endif %}>
                <span class="objective-status {% if loop.index0 in completed_objectives %}completed{% endif %}">
                  [{{ 'âœ“' if loop.index0 in completed_objectives else ' ' }}]
                </span> {{ obj }}
            </li>
            {% endfor %}
        </ul>
        {% if mission.tools_available %}
        <h3>Available Tools:</h3>
        <div class="tools-list" style="display: flex; gap: 18px; margin-bottom: 20px;">
            {% if 'Network Scanner' in mission.tools_available %}
            <button class="tool-btn" data-tool="network-scanner">Network Scanner</button>
            {% endif %}
            {% if 'Log Analyzer' in mission.tools_available %}
            <button class="tool-btn" data-tool="log-analyzer">Log Analyzer</button>
            {% endif %}
            {% if 'Password Cracker' in mission.tools_available %}
            <button class="tool-btn" data-tool="password-cracker">Password Cracker</button>
            {% endif %}
            {% if 'File Recovery' in mission.tools_available %}
            <button class="tool-btn" data-tool="file-recovery">File Recovery</button>
            {% endif %}
        </div>
        <div id="tool-interfaces">
            {% if 'Network Scanner' in mission.tools_available %}
            <div class="tool-interface" id="network-scanner-interface" style="display: none;">
                <h4>Network Scanner</h4>
                <div class="tool-controls">
                    <button class="tool-action-btn" id="start-scan">Start Scan</button>
                    <button class="tool-action-btn" id="stop-scan" disabled>Stop</button>
                </div>
                <div class="tool-content">
                    <div class="scan-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="scan-status">Ready to scan</div>
                    </div>
                    <div class="scan-results">
                        <pre id="scan-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if 'Log Analyzer' in mission.tools_available %}
            <div class="tool-interface" id="log-analyzer-interface" style="display: none;">
                <h4>Log Analyzer</h4>
                <div class="tool-controls">
                    <select id="log-type">
                        <option value="system">System Logs</option>
                        <option value="security">Security Logs</option>
                        <option value="application">Application Logs</option>
                    </select>
                    <button class="tool-action-btn" id="analyze-logs">Analyze</button>
                </div>
                <div class="tool-content">
                    <div class="log-filters">
                        <input type="text" id="log-search" placeholder="Search logs...">
                        <input type="datetime-local" id="log-time-start">
                        <input type="datetime-local" id="log-time-end">
                    </div>
                    <div class="log-results">
                        <pre id="log-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if 'Password Cracker' in mission.tools_available %}
            <div class="tool-interface" id="password-cracker-interface" style="display: none;">
                <h4>Password Cracker</h4>
                <div class="tool-controls">
                    <input type="text" id="hash-input" placeholder="Enter hash...">
                    <button class="tool-action-btn" id="crack-hash">Crack</button>
                </div>
                <div class="tool-content">
                    <div class="crack-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="crack-status">Ready</div>
                    </div>
                    <div class="crack-results">
                        <pre id="crack-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if 'File Recovery' in mission.tools_available %}
            <div class="tool-interface" id="file-recovery-interface" style="display: none;">
                <h4>File Recovery</h4>
                <div class="tool-controls">
                    <input type="text" id="file-path" placeholder="Enter file path...">
                    <button class="tool-action-btn" id="recover-file">Recover</button>
                </div>
                <div class="tool-content">
                    <div class="recovery-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: 0%"></div>
                        </div>
                        <div class="recovery-status">Ready</div>
                    </div>
                    <div class="recovery-results">
                        <pre id="recovery-output"></pre>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Mission Start Interface -->
        <div id="mission-start-interface" class="mission-start-interface">
            <div class="mission-briefing">
                <h3>Mission Briefing</h3>
                <p>Review the objectives above and prepare your investigation tools. Click the button below when ready to begin.</p>
            </div>
            
            <button id="start-mission-btn" class="start-mission-btn">
                <i class="fas fa-play"></i>
                Start Investigation
            </button>
        </div>

        <!-- Investigation Interface (hidden initially) -->
        <div id="investigation-interface" class="investigation-interface" style="display: none;">
            <!-- Visual Novel Style Dialogue System -->
            <div id="dialogue-overlay" class="dialogue-overlay" style="display: none;">
                <div class="dialogue-container">
                    <div class="dialogue-portrait-section">
                        <div class="npc-portrait-frame">
                            <div id="npc-portrait" class="npc-portrait"></div>
                        </div>
                        <div class="npc-name-plate">
                            <span id="npc-name">NPC Name</span>
                        </div>
                    </div>
                    
                    <div class="dialogue-box">
                        <div class="dialogue-text-area">
                            <p id="dialogue-text"></p>
                        </div>
                        <div class="dialogue-choices" id="dialogue-choices">
                            <!-- Choice buttons will be added here -->
                        </div>
                        <div class="dialogue-continue" id="dialogue-continue" style="display: none;">
                            <span>Click to continue...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Tool Panel -->
            <div class="game-tools-panel">
                <h3>Investigation Tools</h3>
                <div class="tools-grid">
                    <button id="start-dialogue-btn" class="game-tool-btn dialogue-tool">
                        <i class="fas fa-comments"></i>
                        <span>Interview Contacts</span>
                    </button>
                    
                    <button id="evidence-scanner-btn" class="game-tool-btn scanner-tool">
                        <i class="fas fa-search"></i>
                        <span>Evidence Scanner</span>
                    </button>
                    
                    <button id="forensics-kit-btn" class="game-tool-btn forensics-tool">
                        <i class="fas fa-microscope"></i>
                        <span>Digital Forensics</span>
                    </button>
                    
                    <button id="intel-database-btn" class="game-tool-btn intel-tool">
                        <i class="fas fa-database"></i>
                        <span>Intel Database</span>
                    </button>
                    
                    <button id="threat-analyzer-btn" class="game-tool-btn threat-tool">
                        <i class="fas fa-shield-alt"></i>
                        <span>Threat Analysis</span>
                    </button>
                    
                    <button id="mission-notes-btn" class="game-tool-btn notes-tool">
                        <i class="fas fa-sticky-note"></i>
                        <span>Mission Notes</span>
                    </button>
                </div>
            </div>
            
            <button id="back-to-briefing-btn" class="back-to-briefing-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Briefing
            </button>
        </div>
        
        <a href="{{ url_for('game') }}" class="back-btn">Back to Map</a>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
window.completedObjectives = JSON.parse('{{ completed_objectives|tojson|safe }}');
window.totalObjectives = parseInt('{{ mission.objectives|length }}');
window.missionLocation = "{{ location }}";
// Timer
let timeLeft = parseInt('{{ mission.timeLimit if mission and mission.timeLimit else 1800 }}');
function updateTimer() {
    const timerValue = document.getElementById('timer-value');
    if (!timerValue) return;
    let min = Math.floor(timeLeft / 60);
    let sec = timeLeft % 60;
    timerValue.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
    if (timeLeft > 0) {
        timeLeft--;
        setTimeout(updateTimer, 1000);
    } else {
        document.getElementById('mission-timer').textContent = "Mission Failed!";
    }
}
if (document.getElementById('timer-value')) updateTimer();
// Toast/markObjective/saveObjectives globally
window.markObjectiveComplete = function(index) {
    if (!window.completedObjectives.includes(index)) {
        window.completedObjectives.push(index);
        window.saveObjectives();
        const objList = document.getElementById('objectives-list');
        if (objList) {
            const li = objList.querySelector(`li[data-index="${index}"]`);
            if (li) {
                li.querySelector('.objective-status').textContent = '[âœ“]';
                li.querySelector('.objective-status').style.color = '#38d39f';
                li.classList.add('completed');
                showObjectiveToast("Objective completed!");
            }
        }
        if (window.completedObjectives.length === window.totalObjectives) {
            showObjectiveToast("All objectives completed!");
        }
    }
};
window.showObjectiveToast = function(msg) {
    let toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '28px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = '#232323';
    toast.style.color = '#38d39f';
    toast.style.padding = '12px 24px';
    toast.style.borderRadius = '12px';
    toast.style.zIndex = 9999;
    toast.style.fontSize = '1.1em';
    toast.style.boxShadow = '0 2px 16px #0008';
    document.body.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 1500);
};
window.saveObjectives = function() {
    fetch(window.location.pathname, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({completed: window.completedObjectives})
    });
};
// Tools tab switching
document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tool-interface').forEach(div => div.style.display = 'none');
        const toolId = btn.getAttribute('data-tool');
        const interfaceDiv = document.getElementById(`${toolId}-interface`);
        if (interfaceDiv) interfaceDiv.style.display = 'block';
    });
});


// Mission management variables
let investigationActive = false;

// Mission Interface Management

// Mission Start Button
document.getElementById('start-mission-btn').addEventListener('click', function() {
    startInvestigation();
});

// Back to Briefing Button
document.getElementById('back-to-briefing-btn').addEventListener('click', function() {
    backToBriefing();
});

function startInvestigation() {
    if (!investigationActive) {
        investigationActive = true;
        
        // Hide mission start interface
        document.getElementById('mission-start-interface').style.display = 'none';
        
        // Show investigation interface with animation
        const investigationInterface = document.getElementById('investigation-interface');
        investigationInterface.style.display = 'block';
        
        // Start mission timer
        if (document.getElementById('timer-value')) updateTimer();
        
        // Show success message
        showObjectiveToast("Investigation started! Use the tools below to gather evidence and interview contacts.");
    }
}

function backToBriefing() {
    // Hide investigation interface
    document.getElementById('investigation-interface').style.display = 'none';
    
    // Show mission start interface
    document.getElementById('mission-start-interface').style.display = 'block';
    
    // Hide any open dialogues
    document.getElementById('dialogue-overlay').style.display = 'none';
    
    investigationActive = false;
}

// Visual Novel Dialogue System
let currentDialogue = null;
let currentNPC = null;
let continueClickHandler = null;

function showDialogue(npcName, dialogueText, choices = []) {
    const overlay = document.getElementById('dialogue-overlay');
    const npcNameEl = document.getElementById('npc-name');
    const dialogueTextEl = document.getElementById('dialogue-text');
    const choicesContainer = document.getElementById('dialogue-choices');
    const continueEl = document.getElementById('dialogue-continue');
    
    // Set NPC name and dialogue
    npcNameEl.textContent = npcName;
    
    // Type out dialogue text
    typeDialogueText(dialogueText, dialogueTextEl);
    
    // Generate NPC portrait
    generateNPCPortrait(npcName);
    
    // Clear previous choices
    choicesContainer.innerHTML = '';
    
    if (choices.length > 0) {
        continueEl.style.display = 'none';
        choices.forEach((choice, index) => {
            const choiceBtn = document.createElement('button');
            choiceBtn.className = 'dialogue-choice-btn';
            choiceBtn.textContent = choice.text;
            choiceBtn.addEventListener('click', () => {
                if (choice.action) choice.action();
                if (choice.nextDialogue) {
                    showDialogue(choice.nextDialogue.npc, choice.nextDialogue.text, choice.nextDialogue.choices);
                } else {
                    hideDialogue();
                }
            });
            choicesContainer.appendChild(choiceBtn);
        });
    } else {
        continueEl.style.display = 'block';
        // Remove any existing event listener
        if (continueClickHandler) {
            continueEl.removeEventListener('click', continueClickHandler);
        }
        // Create new handler and add it
        continueClickHandler = function(event) {
            console.log('Continue clicked!');
            event.preventDefault();
            event.stopPropagation();
            hideDialogue();
        };
        continueEl.addEventListener('click', continueClickHandler);
    }
    
    overlay.style.display = 'flex';
}

function hideDialogue() {
    document.getElementById('dialogue-overlay').style.display = 'none';
}

function typeDialogueText(text, element) {
    element.textContent = '';
    let index = 0;
    const speed = 30; // milliseconds per character
    
    function typeChar() {
        if (index < text.length) {
            element.textContent += text.charAt(index);
            index++;
            setTimeout(typeChar, speed);
        }
    }
    
    typeChar();
}

function generateNPCPortrait(npcName) {
    const portraitEl = document.getElementById('npc-portrait');
    
    // Create random avatar layers for the NPC
    const avatarLayers = ['character', 'hair', 'clothes', 'face', 'accessories'];
    portraitEl.innerHTML = '';
    
    avatarLayers.forEach(layer => {
        const img = document.createElement('img');
        img.className = 'avatar-layer';
        img.src = `/static/images/avatar_parts/${layer}/${getNPCVariant(npcName, layer)}.png`;
        img.onerror = function() { this.style.display = 'none'; }; // Hide if image doesn't exist
        portraitEl.appendChild(img);
    });
}

function getNPCVariant(npcName, layer) {
    // Generate consistent avatar parts based on NPC name
    const hash = npcName.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0);
    const variants = {
        'character': ['character1', 'character2', 'character3'],
        'hair': ['hair1', 'hair2', 'hair3', 'hair4'],
        'clothes': ['clothes1', 'clothes2', 'clothes3', 'clothes4'],
        'face': ['face1', 'face2', 'face3'],
        'accessories': ['glasses', 'hat', 'scarf', 'none']
    };
    
    const layerVariants = variants[layer] || ['default'];
    return layerVariants[Math.abs(hash) % layerVariants.length];
}

// Mission dialogues are loaded from dialogues.js

// Enhanced Investigation Tools
document.getElementById('evidence-scanner-btn').addEventListener('click', function() {
    showToolInterface('Evidence Scanner', 'Scanning for digital evidence and artifacts...', [
        { name: 'Scan File System', action: () => scanFileSystem() },
        { name: 'Analyze Network Traffic', action: () => analyzeTraffic() },
        { name: 'Check Registry Keys', action: () => checkRegistry() }
    ]);
});

document.getElementById('forensics-kit-btn').addEventListener('click', function() {
    showToolInterface('Digital Forensics Kit', 'Advanced forensic analysis tools for deep investigation.', [
        { name: 'Memory Dump Analysis', action: () => memoryAnalysis() },
        { name: 'Timeline Construction', action: () => buildTimeline() },
        { name: 'Hash Verification', action: () => verifyHashes() }
    ]);
});

document.getElementById('intel-database-btn').addEventListener('click', function() {
    showToolInterface('Intelligence Database', 'Access SECTOR-9 threat intelligence and historical data.', [
        { name: 'Search Known Threats', action: () => searchThreats() },
        { name: 'Check IOCs', action: () => checkIOCs() },
        { name: 'View Case History', action: () => viewHistory() }
    ]);
});

document.getElementById('threat-analyzer-btn').addEventListener('click', function() {
    showToolInterface('Threat Analysis Engine', 'AI-powered threat detection and analysis system.', [
        { name: 'Behavioral Analysis', action: () => behaviorAnalysis() },
        { name: 'Malware Detection', action: () => malwareDetection() },
        { name: 'Attribution Analysis', action: () => attributionAnalysis() }
    ]);
});

document.getElementById('mission-notes-btn').addEventListener('click', function() {
    showMissionNotes();
});

function showToolInterface(toolName, description, actions) {
    // Create a modal-like interface for tools
    const overlay = document.createElement('div');
    overlay.className = 'tool-overlay';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
        align-items: center; justify-content: center;
    `;
    
    const panel = document.createElement('div');
    panel.className = 'tool-panel';
    panel.style.cssText = `
        background: #1a1a2e; border: 3px solid #6C5CE7; border-radius: 15px;
        padding: 30px; max-width: 500px; width: 90%; color: white;
        font-family: 'Share Tech Mono', monospace;
    `;
    
    panel.innerHTML = `
        <h2 style="color: #A499FF; margin-bottom: 15px; text-align: center;">${toolName}</h2>
        <p style="margin-bottom: 20px; line-height: 1.6; opacity: 0.9;">${description}</p>
        <div class="tool-actions" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
            ${actions.map(action => `
                <button class="tool-action-btn" style="
                    background: #2c2c54; border: 1px solid #6C5CE7; border-radius: 8px;
                    padding: 12px 20px; color: white; cursor: pointer; transition: all 0.3s;
                    font-family: 'Share Tech Mono', monospace;
                " onmouseover="this.style.background='#6C5CE7'" 
                   onmouseout="this.style.background='#2c2c54'"
                   onclick="(${action.action.toString()})(); document.body.removeChild(document.querySelector('.tool-overlay'));">
                    ${action.name}
                </button>
            `).join('')}
        </div>
        <button onclick="document.body.removeChild(document.querySelector('.tool-overlay'))" 
                style="background: #dc3545; border: none; border-radius: 8px; padding: 10px 20px; 
                       color: white; cursor: pointer; width: 100%; font-family: 'Share Tech Mono', monospace;">
            Close
        </button>
    `;
    
    overlay.appendChild(panel);
    document.body.appendChild(overlay);
}

// Tool Functions
function scanFileSystem() {
    window.markObjectiveComplete(0);
    alert('ðŸ” File system scan complete! Suspicious files detected in temp directory.');
}

function analyzeTraffic() {
    window.markObjectiveComplete(1);
    alert('ðŸ“¡ Network analysis complete! Anomalous outbound connections identified.');
}

function checkRegistry() {
    window.markObjectiveComplete(2);
    alert('ðŸ”‘ Registry scan complete! Unauthorized persistence mechanisms found.');
}

function memoryAnalysis() {
    window.markObjectiveComplete(1);
    alert('ðŸ§  Memory dump analysis complete! Injected code detected in explorer.exe.');
}

function buildTimeline() {
    alert('â° Timeline constructed! Attack sequence: Initial access â†’ Privilege escalation â†’ Data exfiltration.');
}

function verifyHashes() {
    alert('ðŸ” Hash verification complete! 3 files modified, 1 file replaced with malicious version.');
}

function searchThreats() {
    alert('ðŸŽ¯ Threat database search complete! Pattern matches APT group "PH4NT0M" tactics.');
}

function checkIOCs() {
    window.markObjectiveComplete(3);
    alert('âš ï¸ IOC check complete! 5 indicators match known PH4NT0M infrastructure.');
}

function viewHistory() {
    alert('ðŸ“š Case history loaded! Previous PH4NT0M attacks show similar modus operandi.');
}

function behaviorAnalysis() {
    alert('ðŸ¤– Behavioral analysis complete! Detected lateral movement and data staging activities.');
}

function malwareDetection() {
    window.markObjectiveComplete(2);
    alert('ðŸ¦  Malware detected! Custom RAT with C2 communication capabilities identified.');
}

function attributionAnalysis() {
    alert('ðŸ•µï¸ Attribution analysis complete! High confidence attribution to PH4NT0M group based on TTPs.');
}

function showMissionNotes() {
    const notes = localStorage.getItem('missionNotes') || 'No notes yet. Click to add your observations...';
    const newNotes = prompt('Mission Notes:', notes);
    if (newNotes !== null) {
        localStorage.setItem('missionNotes', newNotes);
        alert('Notes saved successfully!');
    }
}

// Start dialogue button - now shows NPC selection
document.getElementById('start-dialogue-btn').addEventListener('click', function() {
    const levelKey = window.missionLocation;
    const dialogues = window.missionDialogues ? window.missionDialogues[levelKey] : null;
    
    if (dialogues) {
        const npcNames = Object.keys(dialogues);
        
        if (npcNames.length === 1) {
            // Only one NPC available, start dialogue directly
            const npcName = npcNames[0];
            const npcDialogue = dialogues[npcName];
            showDialogue(npcName, npcDialogue.text, npcDialogue.choices);
        } else {
            // Multiple NPCs available, let player choose
            const choices = npcNames.map(npcName => ({
                text: `Talk to ${npcName}`,
                nextDialogue: {
                    npc: npcName,
                    text: dialogues[npcName].text,
                    choices: dialogues[npcName].choices
                }
            }));
            
            showDialogue('SECTOR-9 HQ', 'Agent, you have multiple contacts available for this mission. Who would you like to interview first?', choices);
        }
    } else {
        // Default dialogue for levels without specific NPCs
        showDialogue('SECTOR-9 Command', 'Agent, intelligence is limited for this mission. Proceed with your investigation using available tools.', [
            { text: "Understood. Beginning investigation.", action: () => console.log("Starting investigation") },
            { text: "Any additional intel I should know about?" }
        ]);
    }
});
</script>
<script src="{{ url_for('static', filename='js/tools.js') }}"></script>
<script src="{{ url_for('static', filename='js/dialogues.js') }}"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mission.css') }}">
{% endblock %}
