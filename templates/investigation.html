{% extends "base.html" %}
{% block title %}Investigation - {{ location_name }}{% endblock %}

{% block content %}
<div class="investigation-container">
    <!-- Location Background -->
    <div class="location-background" style="background-image: url('/static/images/backgrounds/{{ location }}.png');">
        
        <!-- Player Avatar -->
        <div id="player-avatar" class="player-avatar">
            {% if avatar_parts %}
                {% for category, part in avatar_parts.items() %}
                    {% if category == 'characters' %}
                        <img class="avatar-layer" src="/static/images/avatar_parts/{{ category }}/{{ part.name if part is mapping else part }}.png" alt="{{ category }}">
                    {% else %}
                        {% set part_name = part.name if part is mapping else 'default' %}
                        {% set subcategory = part.subcategory if part is mapping else 'default' %}
                        <img class="avatar-layer" src="/static/images/avatar_parts/{{ category }}/{{ subcategory }}/{{ part_name }}.png" alt="{{ category }}">
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <!-- NPC Avatar -->
        <div id="npc-avatar" class="npc-avatar">
            <!-- NPC will be generated by JavaScript -->
        </div>

        <!-- Investigation Toolbar -->
        <div class="investigation-toolbar">
            <div class="toolbar-header">
                <h3><i class="fas fa-search"></i> Investigation Tools</h3>
                <button id="toggle-toolbar" class="toolbar-toggle">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="toolbar-content">
                <div class="tools-grid">
                    <button id="start-dialogue-btn" class="tool-btn dialogue-tool">
                        <i class="fas fa-comments"></i>
                        <span>Interview</span>
                    </button>
                    
                    <button id="evidence-scanner-btn" class="tool-btn scanner-tool">
                        <i class="fas fa-search"></i>
                        <span>Evidence Scanner</span>
                    </button>
                    
                    <button id="forensics-kit-btn" class="tool-btn forensics-tool">
                        <i class="fas fa-microscope"></i>
                        <span>Digital Forensics</span>
                    </button>
                    
                    <button id="intel-database-btn" class="tool-btn intel-tool">
                        <i class="fas fa-database"></i>
                        <span>Intel Database</span>
                    </button>
                    
                    <button id="threat-analyzer-btn" class="tool-btn threat-tool">
                        <i class="fas fa-shield-alt"></i>
                        <span>Threat Analysis</span>
                    </button>
                    
                    <button id="mission-notes-btn" class="tool-btn notes-tool">
                        <i class="fas fa-sticky-note"></i>
                        <span>Mission Notes</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tool Interface Panel -->
        <div id="tool-interface" class="tool-interface" style="display: none;">
            <div class="tool-panel">
                <h2 id="tool-title">Tool Name</h2>
                <p id="tool-description">Tool description here...</p>
                
                <div id="tool-content">
                    <!-- Dynamic tool content will be loaded here -->
                </div>
                
                <button id="close-tool" class="close-tool-btn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>

        <!-- Visual Novel Dialogue System -->
        <div id="dialogue-overlay" class="dialogue-overlay" style="display: none;">
            <div class="dialogue-container">
                <div class="dialogue-portrait-section">
                    <div class="npc-portrait-frame">
                        <div id="npc-portrait" class="npc-portrait"></div>
                    </div>
                    <div class="npc-name-plate">
                        <span id="npc-name">NPC Name</span>
                    </div>
                </div>
                
                <div class="dialogue-box">
                    <div class="dialogue-text-area">
                        <p id="dialogue-text"></p>
                    </div>
                    <div class="dialogue-choices" id="dialogue-choices">
                        <!-- Choice buttons will be added here -->
                    </div>
                    <div class="dialogue-continue" id="dialogue-continue" style="display: none;">
                        <span>Click to continue...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Investigation HUD -->
        <div class="investigation-hud">
            <div class="hud-item location-info">
                <h4>{{ location_name }}</h4>
                <p>Agent {{ name }}</p>
            </div>
            
            <div class="hud-item objectives-panel">
                <h4><i class="fas fa-tasks"></i> Objectives</h4>
                <div id="objectives-status">
                    <span id="objectives-count">0/4 Complete</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="investigation-navigation">
            <a href="/mission/{{ location }}" class="nav-btn back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Briefing
            </a>
            <a href="/game" class="nav-btn map-btn">
                <i class="fas fa-map"></i>
                Return to Map
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Investigation System Variables
let currentDialogue = null;
let currentNPC = null;
let continueClickHandler = null;
let toolbarCollapsed = false;
let objectivesCompleted = 0;
const totalObjectives = 4;
const missionLocation = "{{ location }}";
const locationName = "{{ location_name }}";

// Make markObjectiveComplete available globally for dialogues.js
window.markObjectiveComplete = function(index) {
    completeObjective();
    console.log('Objective', index, 'completed via dialogue');
};

// Initialize investigation system
document.addEventListener('DOMContentLoaded', function() {
    initializeInvestigation();
    setupToolbarEvents();
    setupToolEvents();
});

function initializeInvestigation() {
    // Generate initial NPC for this location
    generateLocationNPC();
    
    // Auto-start with a welcome dialogue
    setTimeout(() => {
        startWelcomeDialogue();
    }, 1000);
}

// Map locations to level keys for dialogue system
function getDialogueLevelKey(location) {
    const locationToLevel = {
        'company': 'level1',
        'news': 'level2', 
        'bank': 'level3',
        'school': 'level6',
        'cafe': 'level4',
        'transport': 'level5',
        'hospital': 'level8',
        'government': 'level7',
        'hq': 'level9',
        'global': 'level10'
    };
    return locationToLevel[location] || 'level1';
}

function generateLocationNPC() {
    const npcAvatar = document.getElementById('npc-avatar');
    const avatarLayers = ['character', 'hair', 'clothes', 'face', 'accessories'];
    npcAvatar.innerHTML = '';
    
    avatarLayers.forEach(layer => {
        const img = document.createElement('img');
        img.className = 'avatar-layer';
        img.src = `/static/images/avatar_parts/${layer}/${getNPCVariant(locationName, layer)}.png`;
        img.onerror = function() { this.style.display = 'none'; };
        npcAvatar.appendChild(img);
    });
}

function getNPCVariant(npcName, layer) {
    const hash = npcName.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0);
    const variants = {
        'character': ['character1', 'character2', 'character3'],
        'hair': ['hair1', 'hair2', 'hair3', 'hair4'],
        'clothes': ['clothes1', 'clothes2', 'clothes3', 'clothes4'],
        'face': ['face1', 'face2', 'face3'],
        'accessories': ['glasses', 'hat', 'scarf', 'none']
    };
    
    const layerVariants = variants[layer] || ['default'];
    return layerVariants[Math.abs(hash) % layerVariants.length];
}

function startWelcomeDialogue() {
    showDialogue('SECTOR-9 Command', `Agent, you've arrived at ${locationName}. The situation is critical and requires immediate investigation. Use your tools to gather evidence and interview any available contacts.`, [
        { text: "Understood. Beginning investigation now.", choices: [] },
        { text: "What's the threat level here?", nextDialogue: { npc: 'SECTOR-9 Command', text: 'Threat level is HIGH. Multiple attack vectors detected. Proceed with caution and report findings immediately.', choices: [] }},
        { text: "I'm ready to start interviewing contacts.", action: () => startContactInterviews() }
    ]);
}

function startContactInterviews() {
    // Load dialogues for this location from dialogues.js
    const levelKey = getDialogueLevelKey(missionLocation);
    console.log('Looking for dialogues with key:', levelKey, 'for location:', missionLocation);
    
    if (window.missionDialogues && window.missionDialogues[levelKey]) {
        const dialogues = window.missionDialogues[levelKey];
        const npcNames = Object.keys(dialogues);
        console.log('Found NPCs:', npcNames);
        
        if (npcNames.length === 1) {
            // Only one NPC available, start dialogue directly
            const npcName = npcNames[0];
            const npcDialogue = dialogues[npcName];
            showDialogue(npcName, npcDialogue.text, npcDialogue.choices);
        } else if (npcNames.length > 1) {
            // Multiple NPCs available, let player choose
            const choices = npcNames.map(npcName => ({
                text: `Talk to ${npcName}`,
                nextDialogue: {
                    npc: npcName,
                    text: dialogues[npcName].text,
                    choices: dialogues[npcName].choices
                }
            }));
            
            showDialogue('SECTOR-9 HQ', `Agent, you have multiple contacts available at ${locationName}. Who would you like to interview first?`, choices);
        } else {
            showDialogue('SECTOR-9 Command', 'No specific contacts available for this location. Use your investigation tools to gather evidence.', []);
        }
    } else {
        console.log('No dialogues found for level key:', levelKey);
        console.log('Available keys:', window.missionDialogues ? Object.keys(window.missionDialogues) : 'missionDialogues not loaded');
        showDialogue('Local Contact', `Agent, welcome to ${locationName}. The situation here requires immediate investigation.`, [
            { text: "I'll start using my investigation tools.", choices: [] }
        ]);
    }
}

function setupToolbarEvents() {
    const toggleBtn = document.getElementById('toggle-toolbar');
    const toolbarContent = document.querySelector('.toolbar-content');
    
    toggleBtn.addEventListener('click', function() {
        toolbarCollapsed = !toolbarCollapsed;
        if (toolbarCollapsed) {
            toolbarContent.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        } else {
            toolbarContent.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        }
    });
}

function setupToolEvents() {
    // Interview button
    document.getElementById('start-dialogue-btn').addEventListener('click', function() {
        startContactInterviews();
    });

    // Evidence Scanner
    document.getElementById('evidence-scanner-btn').addEventListener('click', function() {
        showToolInterface('Evidence Scanner', 'Advanced digital evidence detection and analysis', 'evidence-scanner');
    });

    // Digital Forensics
    document.getElementById('forensics-kit-btn').addEventListener('click', function() {
        showToolInterface('Digital Forensics Kit', 'Comprehensive forensic analysis tools', 'forensics');
    });

    // Intel Database
    document.getElementById('intel-database-btn').addEventListener('click', function() {
        showToolInterface('Intelligence Database', 'SECTOR-9 threat intelligence and case history', 'intel-database');
    });

    // Threat Analyzer
    document.getElementById('threat-analyzer-btn').addEventListener('click', function() {
        showToolInterface('Threat Analysis Engine', 'AI-powered threat detection and attribution', 'threat-analyzer');
    });

    // Mission Notes
    document.getElementById('mission-notes-btn').addEventListener('click', function() {
        showToolInterface('Mission Notes', 'Record observations and findings', 'mission-notes');
    });

    // Close tool button
    document.getElementById('close-tool').addEventListener('click', function() {
        document.getElementById('tool-interface').style.display = 'none';
    });
}

function showToolInterface(title, description, toolType) {
    const toolInterface = document.getElementById('tool-interface');
    const toolTitle = document.getElementById('tool-title');
    const toolDescription = document.getElementById('tool-description');
    const toolContent = document.getElementById('tool-content');

    toolTitle.textContent = title;
    toolDescription.textContent = description;
    
    // Generate tool-specific content
    toolContent.innerHTML = generateToolContent(toolType);
    
    toolInterface.style.display = 'flex';
}

function generateToolContent(toolType) {
    switch(toolType) {
        case 'evidence-scanner':
            return `
                <div class="tool-actions">
                    <button onclick="scanFileSystem()" class="tool-action-btn">
                        <i class="fas fa-hdd"></i> Scan File System
                    </button>
                    <button onclick="analyzeTraffic()" class="tool-action-btn">
                        <i class="fas fa-network-wired"></i> Analyze Network Traffic
                    </button>
                    <button onclick="checkRegistry()" class="tool-action-btn">
                        <i class="fas fa-cogs"></i> Check Registry Keys
                    </button>
                </div>
                <div class="scan-results" id="scan-results">
                    <p>Ready to scan. Select an option above.</p>
                </div>
            `;
        case 'forensics':
            return `
                <div class="tool-actions">
                    <button onclick="memoryAnalysis()" class="tool-action-btn">
                        <i class="fas fa-memory"></i> Memory Dump Analysis
                    </button>
                    <button onclick="buildTimeline()" class="tool-action-btn">
                        <i class="fas fa-clock"></i> Timeline Construction
                    </button>
                    <button onclick="verifyHashes()" class="tool-action-btn">
                        <i class="fas fa-fingerprint"></i> Hash Verification
                    </button>
                </div>
                <div class="analysis-results" id="analysis-results">
                    <p>Select a forensic analysis tool above.</p>
                </div>
            `;
        case 'intel-database':
            return `
                <div class="search-container">
                    <input type="text" placeholder="Search threats, IOCs, signatures..." class="search-input">
                    <button onclick="searchDatabase()" class="search-btn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="tool-actions">
                    <button onclick="searchThreats()" class="tool-action-btn">
                        <i class="fas fa-virus"></i> Known Threats
                    </button>
                    <button onclick="checkIOCs()" class="tool-action-btn">
                        <i class="fas fa-exclamation-triangle"></i> Check IOCs
                    </button>
                    <button onclick="viewHistory()" class="tool-action-btn">
                        <i class="fas fa-history"></i> Case History
                    </button>
                </div>
                <div class="database-results" id="database-results">
                    <p>Database ready. Search or select a quick action.</p>
                </div>
            `;
        case 'threat-analyzer':
            return `
                <div class="analyzer-status">
                    <div class="status-indicator">
                        <span class="status-dot warning"></span>
                        Threat Level: HIGH
                    </div>
                </div>
                <div class="tool-actions">
                    <button onclick="behaviorAnalysis()" class="tool-action-btn">
                        <i class="fas fa-chart-line"></i> Behavioral Analysis
                    </button>
                    <button onclick="malwareDetection()" class="tool-action-btn">
                        <i class="fas fa-bug"></i> Malware Detection
                    </button>
                    <button onclick="attributionAnalysis()" class="tool-action-btn">
                        <i class="fas fa-user-secret"></i> Attribution Analysis
                    </button>
                </div>
                <div class="threat-results" id="threat-results">
                    <p>AI threat analysis engine ready.</p>
                </div>
            `;
        case 'mission-notes':
            return `
                <div class="notes-container">
                    <textarea id="mission-notes-text" placeholder="Record your observations, findings, and theories here..." rows="8">${localStorage.getItem('missionNotes') || ''}</textarea>
                    <div class="notes-actions">
                        <button onclick="saveNotes()" class="tool-action-btn">
                            <i class="fas fa-save"></i> Save Notes
                        </button>
                        <button onclick="clearNotes()" class="tool-action-btn">
                            <i class="fas fa-trash"></i> Clear Notes
                        </button>
                    </div>
                </div>
            `;
        default:
            return '<p>Tool interface not implemented.</p>';
    }
}

// Tool Functions
function scanFileSystem() {
    completeObjective();
    document.getElementById('scan-results').innerHTML = `
        <div class="result-item success">
            <i class="fas fa-check"></i>
            <strong>File System Scan Complete</strong><br>
            Found 247 suspicious files in temp directory. Potential malware signatures detected.
        </div>
    `;
}

function analyzeTraffic() {
    completeObjective();
    document.getElementById('scan-results').innerHTML = `
        <div class="result-item warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Network Analysis Complete</strong><br>
            Detected 15 unauthorized outbound connections to IP 192.168.1.247.
        </div>
    `;
}

function checkRegistry() {
    completeObjective();
    document.getElementById('scan-results').innerHTML = `
        <div class="result-item danger">
            <i class="fas fa-times"></i>
            <strong>Registry Scan Complete</strong><br>
            Found unauthorized persistence mechanisms in HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run.
        </div>
    `;
}

function memoryAnalysis() {
    completeObjective();
    document.getElementById('analysis-results').innerHTML = `
        <div class="result-item info">
            <i class="fas fa-info"></i>
            <strong>Memory Analysis Complete</strong><br>
            Detected code injection in explorer.exe process. Possible RAT activity.
        </div>
    `;
}

function buildTimeline() {
    document.getElementById('analysis-results').innerHTML = `
        <div class="result-item">
            <strong>Attack Timeline Constructed</strong><br>
            1. 02:15 - Initial breach via phishing email<br>
            2. 02:45 - Privilege escalation<br>
            3. 03:30 - Lateral movement<br>
            4. 04:15 - Data exfiltration begins
        </div>
    `;
}

function verifyHashes() {
    document.getElementById('analysis-results').innerHTML = `
        <div class="result-item warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Hash Verification Complete</strong><br>
            3 system files modified, 1 file replaced with malicious version.
        </div>
    `;
}

function searchThreats() {
    completeObjective();
    document.getElementById('database-results').innerHTML = `
        <div class="result-item danger">
            <i class="fas fa-skull"></i>
            <strong>Threat Match Found</strong><br>
            Pattern matches APT group "PH4NT0M" - known for financial sector attacks.
        </div>
    `;
}

function checkIOCs() {
    document.getElementById('database-results').innerHTML = `
        <div class="result-item warning">
            <strong>IOC Analysis Complete</strong><br>
            5 indicators match known PH4NT0M infrastructure:<br>
            • C2 server: 185.243.112.45<br>
            • File hash: a3d2f1e8b9c7...<br>
            • Registry key: HKLM\\SOFTWARE\\Microsoft\\PH4NT0M
        </div>
    `;
}

function viewHistory() {
    document.getElementById('database-results').innerHTML = `
        <div class="result-item info">
            <strong>Case History Loaded</strong><br>
            Previous PH4NT0M attacks show similar modus operandi:<br>
            • Spear phishing campaigns<br>
            • Custom RAT deployment<br>
            • Financial data exfiltration
        </div>
    `;
}

function behaviorAnalysis() {
    document.getElementById('threat-results').innerHTML = `
        <div class="result-item warning">
            <strong>Behavioral Analysis Complete</strong><br>
            Detected patterns consistent with advanced persistent threat:<br>
            • Stealth movement techniques<br>
            • Data staging in temp directories<br>
            • Encrypted command channels
        </div>
    `;
}

function malwareDetection() {
    completeObjective();
    document.getElementById('threat-results').innerHTML = `
        <div class="result-item danger">
            <i class="fas fa-virus"></i>
            <strong>Malware Detected</strong><br>
            Custom Remote Access Trojan (RAT) identified:<br>
            • Name: PH4NT0M-RAT v2.3<br>
            • Capabilities: Keylogging, file exfiltration, remote control
        </div>
    `;
}

function attributionAnalysis() {
    document.getElementById('threat-results').innerHTML = `
        <div class="result-item info">
            <strong>Attribution Analysis Complete</strong><br>
            High confidence attribution to PH4NT0M group based on:<br>
            • Code signatures<br>
            • Infrastructure patterns<br>
            • Timing and techniques
        </div>
    `;
}

function saveNotes() {
    const notes = document.getElementById('mission-notes-text').value;
    localStorage.setItem('missionNotes', notes);
    showToast('Notes saved successfully!');
}

function clearNotes() {
    if (confirm('Are you sure you want to clear all notes?')) {
        document.getElementById('mission-notes-text').value = '';
        localStorage.removeItem('missionNotes');
        showToast('Notes cleared.');
    }
}

function completeObjective() {
    objectivesCompleted = Math.min(objectivesCompleted + 1, totalObjectives);
    document.getElementById('objectives-count').textContent = `${objectivesCompleted}/${totalObjectives} Complete`;
    showToast('Objective completed! Evidence gathered.');
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: #28a745; color: white; padding: 12px 24px; border-radius: 8px;
        z-index: 9999; font-family: 'Share Tech Mono', monospace;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Dialogue System Functions
function showDialogue(npcName, dialogueText, choices = []) {
    const overlay = document.getElementById('dialogue-overlay');
    const npcNameEl = document.getElementById('npc-name');
    const dialogueTextEl = document.getElementById('dialogue-text');
    const choicesContainer = document.getElementById('dialogue-choices');
    const continueEl = document.getElementById('dialogue-continue');
    
    npcNameEl.textContent = npcName;
    typeDialogueText(dialogueText, dialogueTextEl);
    generateNPCPortrait(npcName);
    
    choicesContainer.innerHTML = '';
    
    if (choices.length > 0) {
        continueEl.style.display = 'none';
        choices.forEach((choice, index) => {
            const choiceBtn = document.createElement('button');
            choiceBtn.className = 'dialogue-choice-btn';
            choiceBtn.textContent = choice.text;
            choiceBtn.addEventListener('click', () => {
                if (choice.action) choice.action();
                if (choice.nextDialogue) {
                    showDialogue(choice.nextDialogue.npc, choice.nextDialogue.text, choice.nextDialogue.choices);
                } else {
                    hideDialogue();
                }
            });
            choicesContainer.appendChild(choiceBtn);
        });
    } else {
        continueEl.style.display = 'block';
        if (continueClickHandler) {
            continueEl.removeEventListener('click', continueClickHandler);
        }
        continueClickHandler = function(event) {
            event.preventDefault();
            event.stopPropagation();
            hideDialogue();
        };
        continueEl.addEventListener('click', continueClickHandler);
    }
    
    overlay.style.display = 'flex';
}

function hideDialogue() {
    document.getElementById('dialogue-overlay').style.display = 'none';
}

function typeDialogueText(text, element) {
    element.textContent = '';
    let index = 0;
    const speed = 30;
    
    function typeChar() {
        if (index < text.length) {
            element.textContent += text.charAt(index);
            index++;
            setTimeout(typeChar, speed);
        }
    }
    
    typeChar();
}

function generateNPCPortrait(npcName) {
    const portraitEl = document.getElementById('npc-portrait');
    const avatarLayers = ['character', 'hair', 'clothes', 'face', 'accessories'];
    portraitEl.innerHTML = '';
    
    avatarLayers.forEach(layer => {
        const img = document.createElement('img');
        img.className = 'avatar-layer';
        img.src = `/static/images/avatar_parts/${layer}/${getNPCVariant(npcName, layer)}.png`;
        img.onerror = function() { this.style.display = 'none'; };
        portraitEl.appendChild(img);
    });
}
</script>
<script src="{{ url_for('static', filename='js/dialogues.js') }}"></script>
{% endblock %}

{% block extra_css %}
<style>
.investigation-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}

.location-background {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
}

.player-avatar {
    position: absolute;
    bottom: 20px;
    left: 50px;
    width: 150px;
    height: 200px;
    z-index: 10;
}

.npc-avatar {
    position: absolute;
    bottom: 20px;
    right: 50px;
    width: 150px;
    height: 200px;
    z-index: 10;
}

.player-avatar .avatar-layer,
.npc-avatar .avatar-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.investigation-toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(26, 26, 46, 0.95), rgba(26, 26, 46, 0.8));
    border-top: 3px solid #6C5CE7;
    z-index: 100;
    font-family: 'Share Tech Mono', monospace;
}

.toolbar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background: rgba(108, 92, 231, 0.2);
    color: #A499FF;
}

.toolbar-header h3 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.toolbar-toggle {
    background: none;
    border: 1px solid #6C5CE7;
    color: #A499FF;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toolbar-toggle:hover {
    background: #6C5CE7;
    color: white;
}

.toolbar-content {
    padding: 15px 20px;
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    max-width: 800px;
    margin: 0 auto;
}

.tool-btn {
    background: linear-gradient(145deg, #2c2c54, #40407a);
    border: 2px solid #6C5CE7;
    border-radius: 8px;
    padding: 12px 8px;
    color: white;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    text-decoration: none;
}

.tool-btn:hover {
    background: linear-gradient(145deg, #6C5CE7, #A499FF);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
}

.tool-btn i {
    font-size: 1.2rem;
}

.tool-interface {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
}

.tool-panel {
    background: #1a1a2e;
    border: 3px solid #6C5CE7;
    border-radius: 15px;
    padding: 25px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    color: white;
    font-family: 'Share Tech Mono', monospace;
}

.tool-panel h2 {
    color: #A499FF;
    margin-bottom: 10px;
    text-align: center;
}

.tool-panel p {
    opacity: 0.9;
    margin-bottom: 20px;
    text-align: center;
}

.tool-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.tool-action-btn {
    background: #2c2c54;
    border: 1px solid #6C5CE7;
    border-radius: 8px;
    padding: 12px 15px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Share Tech Mono', monospace;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tool-action-btn:hover {
    background: #6C5CE7;
}

.close-tool-btn {
    background: #dc3545;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    color: white;
    cursor: pointer;
    width: 100%;
    font-family: 'Share Tech Mono', monospace;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.result-item {
    background: #2c2c54;
    border-left: 4px solid #6C5CE7;
    padding: 15px;
    margin: 10px 0;
    border-radius: 0 8px 8px 0;
}

.result-item.success { border-left-color: #28a745; }
.result-item.warning { border-left-color: #ffc107; }
.result-item.danger { border-left-color: #dc3545; }
.result-item.info { border-left-color: #17a2b8; }

.search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.search-input {
    flex: 1;
    background: #2c2c54;
    border: 1px solid #6C5CE7;
    border-radius: 5px;
    padding: 10px;
    color: white;
    font-family: 'Share Tech Mono', monospace;
}

.search-btn {
    background: #6C5CE7;
    border: none;
    border-radius: 5px;
    padding: 10px 15px;
    color: white;
    cursor: pointer;
}

.analyzer-status {
    background: #2c2c54;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    text-align: center;
}

.status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-dot.warning { background: #ffc107; }

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.notes-container textarea {
    width: 100%;
    background: #2c2c54;
    border: 1px solid #6C5CE7;
    border-radius: 8px;
    padding: 15px;
    color: white;
    font-family: 'Share Tech Mono', monospace;
    resize: vertical;
    margin-bottom: 15px;
}

.notes-actions {
    display: flex;
    gap: 10px;
}

.investigation-hud {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 50;
}

.hud-item {
    background: rgba(26, 26, 46, 0.9);
    border: 2px solid #6C5CE7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    color: white;
    font-family: 'Share Tech Mono', monospace;
    min-width: 200px;
}

.hud-item h4 {
    color: #A499FF;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.hud-item p {
    margin: 0;
    opacity: 0.9;
}

.investigation-navigation {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 50;
}

.nav-btn {
    background: linear-gradient(145deg, #2c2c54, #40407a);
    border: 2px solid #6C5CE7;
    border-radius: 8px;
    padding: 10px 15px;
    color: white;
    text-decoration: none;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: linear-gradient(145deg, #6C5CE7, #A499FF);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
}

/* Dialogue overlay styles use existing CSS from style.css */
.dialogue-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.8) !important;
    z-index: 300 !important;
}

@media (max-width: 768px) {
    .tools-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .player-avatar, .npc-avatar {
        width: 100px;
        height: 150px;
    }
    
    .investigation-hud {
        position: relative;
        top: auto;
        left: auto;
        margin: 10px;
    }
}
</style>
{% endblock %} 