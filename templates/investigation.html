{% extends "base.html" %}
{% block title %}Investigation - {{ location_name }}{% endblock %}

{% block content %}
<div class="investigation-container">
    <!-- Clean Location Background -->
    <div class="location-background" data-location="{{ location }}" data-location-name="{{ location_name }}">
        
        <!-- Hamburger Menu (Top Right) -->
        <button class="hamburger-menu" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Dropdown Menu (Hidden by default) -->
        <div class="dropdown-menu hidden" id="dropdown-menu">
            <a href="/mission/{{ location }}" class="menu-item">
                <i class="fas fa-file-alt"></i>
                Mission Briefing
            </a>
            <a href="/game" class="menu-item">
                <i class="fas fa-map"></i>
                Return to Map
            </a>
            <button class="menu-item" id="interview-btn">
                <i class="fas fa-comments"></i>
                Interview Contact
            </button>
            <button class="menu-item" id="scan-btn">
                <i class="fas fa-search"></i>
                Scan Evidence
            </button>
            <button class="menu-item" id="analyze-btn">
                <i class="fas fa-microscope"></i>
                Analyze Data
            </button>
            <button class="menu-item" id="notes-btn">
                <i class="fas fa-sticky-note"></i>
                Mission Notes
            </button>
        </div>

        <!-- Bottom Dialogue System -->
        <div class="dialogue-container" id="dialogue-container">
            <div class="bubble-avatars">
                <div id="speaker-player" class="bubble-avatar"></div>
                <div id="speaker-npc" class="bubble-avatar"></div>
            </div>
            <div class="dialogue-bubble">
                <div class="npc-name" id="npc-name">SECTOR-9 Command</div>
                <div class="dialogue-text" id="dialogue-text">Agent, you've arrived at {{ location_name }}. Use the menu to begin your investigation.</div>
                <div class="dialogue-choices" id="dialogue-choices"></div>
                <div class="dialogue-continue hidden" id="dialogue-continue">
                    <span>Click to continue...</span>
                </div>
            </div>
        </div>

        <!-- Player Avatar in Scene -->
        <div class="player-avatar" id="player-avatar">
            {% if avatar_parts %}
                {% set LAYER_ORDER = ["characters", "clothes", "hair", "face", "acc"] %}
                {% for part in LAYER_ORDER %}
                    {% set value = avatar_parts.get(part) %}
                    {% if value %}
                        {% if part == "characters" %}
                            <img src="{{ url_for('static', filename='images/avatar_parts/characters/' + (value.name if value is mapping and value.name else value|string) + '.png') }}"
                                 alt="{{ part }}" class="avatar-layer">
                        {% elif part in ["clothes", "hair", "face", "acc"] and value is mapping %}
                            {% for subcat, item in value.items() %}
                                {% if item.name and (part != 'acc' or item.name != 'default') %}
                                    {% if part == "acc" %}
                                        <img src="{{ url_for('static', filename='images/avatar_parts/acc/' + item.name + '.png') }}"
                                             alt="{{ subcat }}" class="avatar-layer">
                                    {% else %}
                                        <img src="{{ url_for('static', filename='images/avatar_parts/' + part + '/' + (item.subcategory or subcat) + '/' + item.name + '.png') }}"
                                             alt="{{ subcat }}" class="avatar-layer">
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <!-- Simple Modal for Tools -->
        <div id="tool-modal" class="tool-modal hidden">
            <div class="modal-content">
                <h3 id="modal-title">Tool Name</h3>
                <div id="modal-body"></div>
                <button class="close-modal" id="close-modal">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="{{ url_for('static', filename='js/investigation.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/dialogues.js') }}" defer></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/investigation.css') }}">
{% endblock %} 