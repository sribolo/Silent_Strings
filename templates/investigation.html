{% extends "base.html" %}
{% block title %}Investigation - {{ location_name }}{% endblock %}

{% block content %}
<div class="investigation-container">
    <!-- Clean Location Background -->
    <div class="location-background" data-location="{{ location }}">
        
        <!-- Hamburger Menu (Top Right) -->
        <button class="hamburger-menu" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Dropdown Menu (Hidden by default) -->
        <div class="dropdown-menu hidden" id="dropdown-menu">
            <a href="/mission/{{ location }}" class="menu-item">
                <i class="fas fa-file-alt"></i>
                Mission Briefing
            </a>
            <a href="/game" class="menu-item">
                <i class="fas fa-map"></i>
                Return to Map
            </a>
            <button class="menu-item" id="interview-btn">
                <i class="fas fa-comments"></i>
                Interview Contact
            </button>
            <button class="menu-item" id="scan-btn">
                <i class="fas fa-search"></i>
                Scan Evidence
            </button>
            <button class="menu-item" id="analyze-btn">
                <i class="fas fa-microscope"></i>
                Analyze Data
            </button>
            <button class="menu-item" id="notes-btn">
                <i class="fas fa-sticky-note"></i>
                Mission Notes
            </button>
        </div>

        <!-- Bottom Dialogue System -->
        <div class="dialogue-container" id="dialogue-container">
            <div class="character-portrait">
                <div id="npc-portrait" class="portrait-avatar"></div>
            </div>
            <div class="dialogue-bubble">
                <div class="npc-name" id="npc-name">SECTOR-9 Command</div>
                <div class="dialogue-text" id="dialogue-text">Agent, you've arrived at {{ location_name }}. Use the menu to begin your investigation.</div>
                <div class="dialogue-choices" id="dialogue-choices"></div>
                <div class="dialogue-continue hidden" id="dialogue-continue">
                    <span>Click to continue...</span>
                </div>
            </div>
        </div>

        <!-- Player Avatar in Scene -->
        <div class="player-avatar" id="player-avatar">
            {% if avatar_parts %}
                {% set LAYER_ORDER = ["characters", "clothes", "hair", "face", "acc"] %}
                {% for part in LAYER_ORDER %}
                    {% set value = avatar_parts.get(part) %}
                    {% if value %}
                        {% if part == "characters" %}
                            <img src="{{ url_for('static', filename='images/avatar_parts/characters/' + (value.name if value is mapping and value.name else value|string) + '.png') }}"
                                 alt="{{ part }}" class="avatar-layer">
                        {% elif part in ["clothes", "hair", "face", "acc"] and value is mapping %}
                            {% for subcat, item in value.items() %}
                                {% if item.name and (part != 'acc' or item.name != 'default') %}
                                    {% if part == "acc" %}
                                        <img src="{{ url_for('static', filename='images/avatar_parts/acc/' + item.name + '.png') }}"
                                             alt="{{ subcat }}" class="avatar-layer">
                                    {% else %}
                                        <img src="{{ url_for('static', filename='images/avatar_parts/' + part + '/' + (item.subcategory or subcat) + '/' + item.name + '.png') }}"
                                             alt="{{ subcat }}" class="avatar-layer">
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <!-- Simple Modal for Tools -->
        <div id="tool-modal" class="tool-modal hidden">
            <div class="modal-content">
                <h3 id="modal-title">Tool Name</h3>
                <div id="modal-body"></div>
                <button class="close-modal" id="close-modal">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple variables
let objectivesCompleted = 0;
let totalObjectives = 4;
const missionLocation = "{{ location }}";
const locationName = "{{ location_name }}";

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setBackgroundImage();
    generateNPC();
    setupEvents();
});

// Set background image based on location
function setBackgroundImage() {
    const backgroundDiv = document.querySelector('.location-background');
    const location = backgroundDiv.getAttribute('data-location');
    const levelToLocationMap = {
        'hq': 'hq',
        'news': 'company_1',
        'bank': 'bank',
        'cafe': 'cafe',
        'transport': 'transport',
        'school': 'school',
        'government': 'government',
        'hospital': 'company',
        'company': 'company',
        'global': 'hq'
    };
    const actualLocation = levelToLocationMap[location] || 'hq';
    const imgUrl = `/static/images/backgrounds/${actualLocation}.png`;

    // Preload image to check if it exists
    const img = new Image();
    img.onload = function() {
        backgroundDiv.style.backgroundImage = `url('${imgUrl}')`;
    };
    img.onerror = function() {
        backgroundDiv.style.backgroundImage = `url('/static/images/backgrounds/hq.png')`;
    };
    img.src = imgUrl;

    console.log(`Location: ${location}, Mapped to: ${actualLocation}, URL: ${imgUrl}`);
}

// Generate NPC portrait
function generateNPC() {
    const npcPortrait = document.getElementById('npc-portrait');
    const avatarLayers = ['character', 'hair', 'clothes', 'face'];
    npcPortrait.innerHTML = '';
    
    avatarLayers.forEach(layer => {
        const img = document.createElement('img');
        img.className = 'avatar-layer';
        img.src = `/static/images/avatar_parts/${layer}/${getRandomVariant(layer)}.png`;
        img.onerror = function() { this.style.display = 'none'; };
        npcPortrait.appendChild(img);
    });
}

function getRandomVariant(layer) {
    const variants = {
        'character': ['character1', 'character2', 'character3'],
        'hair': ['hair1', 'hair2', 'hair3', 'hair4'],
        'clothes': ['clothes1', 'clothes2', 'clothes3', 'clothes4'],
        'face': ['face1', 'face2', 'face3']
    };
    const options = variants[layer] || ['default'];
    return options[Math.floor(Math.random() * options.length)];
}

// Setup events
function setupEvents() {
    // Hamburger menu toggle
    const hamburger = document.getElementById('hamburger-menu');
    const dropdown = document.getElementById('dropdown-menu');
    if (hamburger && dropdown) {
        hamburger.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('hidden');
        });
    } else {
        console.warn('Hamburger menu or dropdown-menu not found in DOM');
    }

    // Click outside to close menu
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.hamburger-menu') && !e.target.closest('.dropdown-menu')) {
            if (dropdown) dropdown.classList.add('hidden');
        }
    });

    // Tool buttons
    const interviewBtn = document.getElementById('interview-btn');
    if (interviewBtn) {
        interviewBtn.addEventListener('click', function() { 
            if (dropdown) dropdown.classList.add('hidden');
            startInterview(); 
        });
    }
    const scanBtn = document.getElementById('scan-btn');
    if (scanBtn) {
        scanBtn.addEventListener('click', function() { 
            if (dropdown) dropdown.classList.add('hidden');
            showToolModal('Evidence Scanner', `
                <button onclick="runScan()" class="action-btn">
                    <i class="fas fa-search"></i> Run System Scan
                </button>
                <div id="scan-result" class="result-container"></div>
            `);
        });
    }
    const analyzeBtn = document.getElementById('analyze-btn');
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function() { 
            if (dropdown) dropdown.classList.add('hidden');
            showToolModal('Digital Analysis', `
                <button onclick="runAnalysis()" class="action-btn">
                    <i class="fas fa-microscope"></i> Analyze Evidence
                </button>
                <div id="analysis-result" class="result-container"></div>
            `);
        });
    }
    const notesBtn = document.getElementById('notes-btn');
    if (notesBtn) {
        notesBtn.addEventListener('click', function() { 
            if (dropdown) dropdown.classList.add('hidden');
            const notes = localStorage.getItem('investigationNotes') || '';
            showToolModal('Mission Notes', `
                <textarea id="notes-text" placeholder="Record your findings..." class="notes-textarea">${notes}</textarea>
                <button onclick="saveNotes()" class="action-btn notes-save-btn">
                    <i class="fas fa-save"></i> Save Notes
                </button>
            `);
        });
    }

    // Close modal
    const closeModal = document.getElementById('close-modal');
    if (closeModal) {
        closeModal.addEventListener('click', function() {
            document.getElementById('tool-modal').classList.add('hidden');
        });
    }

    // Continue dialogue
    const dialogueContinue = document.getElementById('dialogue-continue');
    if (dialogueContinue) {
        dialogueContinue.addEventListener('click', function() {
            dialogueContinue.classList.add('hidden');
        });
    }
}

// Tool functions
function runScan() {
    completeObjective();
    document.getElementById('scan-result').innerHTML = `
        <div class="success-message">
            <strong>Scan Complete:</strong> Suspicious files detected in system directory.
        </div>
    `;
}

function runAnalysis() {
    completeObjective();
    document.getElementById('analysis-result').innerHTML = `
        <div class="warning-message">
            <strong>Analysis Complete:</strong> Malware signatures found. Attack vector identified.
        </div>
    `;
}

function saveNotes() {
    const notes = document.getElementById('notes-text').value;
    localStorage.setItem('investigationNotes', notes);
    showToast('Notes saved!');
}

function completeObjective() {
    objectivesCompleted = Math.min(objectivesCompleted + 1, totalObjectives);
    showToast(`Objective completed! (${objectivesCompleted}/${totalObjectives})`);
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: #28a745; color: white; padding: 12px 24px; border-radius: 8px;
        z-index: 9999; font-family: 'Share Tech Mono', monospace;
        animation: fadeInOut 3s ease-in-out;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showToolModal(title, content) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = content;
    document.getElementById('tool-modal').classList.remove('hidden');
}

// Interview system
function startInterview() {
    const levelKey = getDialogueLevelKey(missionLocation);
    
    if (window.missionDialogues && window.missionDialogues[levelKey]) {
        const dialogues = window.missionDialogues[levelKey];
        const npcNames = Object.keys(dialogues);
        
        if (npcNames.length === 1) {
            const npcName = npcNames[0];
            const npcDialogue = dialogues[npcName];
            showDialogue(npcName, npcDialogue.text, npcDialogue.choices);
        } else if (npcNames.length > 1) {
            const choices = npcNames.map(npcName => ({
                text: `Talk to ${npcName}`,
                nextDialogue: {
                    npc: npcName,
                    text: dialogues[npcName].text,
                    choices: dialogues[npcName].choices
                }
            }));
            showDialogue('Contact Selection', 'Who would you like to interview?', choices);
        } else {
            showDialogue('No Contacts', 'No contacts available at this location.', []);
        }
    } else {
        showDialogue('Local Contact', `Welcome to ${locationName}. The situation is critical.`, [
            { text: "I'll investigate immediately.", action: () => {} }
        ]);
    }
}

// Dialogue functions
function showDialogue(npcName, dialogueText, choices = []) {
    document.getElementById('npc-name').textContent = npcName;
    typeText(dialogueText, document.getElementById('dialogue-text'));
    
    const choicesContainer = document.getElementById('dialogue-choices');
    const continueEl = document.getElementById('dialogue-continue');
    
    choicesContainer.innerHTML = '';
    
    if (choices.length > 0) {
        continueEl.classList.add('hidden');
        choices.forEach((choice, index) => {
            const choiceBtn = document.createElement('button');
            choiceBtn.className = 'choice-btn';
            choiceBtn.textContent = choice.text;
            choiceBtn.addEventListener('click', () => {
                if (choice.action) choice.action();
                if (choice.nextDialogue) {
                    showDialogue(choice.nextDialogue.npc, choice.nextDialogue.text, choice.nextDialogue.choices);
                } else {
                    resetDialogue();
                }
            });
            choicesContainer.appendChild(choiceBtn);
        });
    } else {
        continueEl.classList.remove('hidden');
    }
}

function resetDialogue() {
    document.getElementById('npc-name').textContent = 'SECTOR-9 Command';
    document.getElementById('dialogue-text').textContent = 'Investigation ongoing. Use the menu for additional tools.';
    document.getElementById('dialogue-choices').innerHTML = '';
    document.getElementById('dialogue-continue').classList.add('hidden');
}

function typeText(text, element) {
    element.textContent = '';
    let i = 0;
    const timer = setInterval(() => {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
        } else {
            clearInterval(timer);
        }
    }, 30);
}

// Location mapping
function getDialogueLevelKey(location) {
    const locationToLevel = {
        'hq': 'level1', 'news': 'level2', 'bank': 'level3',
        'cafe': 'level4', 'transport': 'level5', 'school': 'level6',
        'government': 'level7', 'hospital': 'level8', 'company': 'level9',
        'global': 'level10'
    };
    return locationToLevel[location] || 'level1';
}

// Global objective function for dialogues
window.markObjectiveComplete = function(index) {
    completeObjective();
};
</script>

<script src="{{ url_for('static', filename='js/dialogues.js') }}" defer></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/investigation.css') }}">
{% endblock %} 