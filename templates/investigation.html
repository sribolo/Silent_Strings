{% extends "base.html" %}
{% block title %}Investigation{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/investigation.css') }}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" nonce="{{ csp_nonce }}">
{% endblock %}

{% block content %}
<div class="investigation-interface">
    <!-- Location Background -->
    <div class="location-background" id="location-bg" data-location="{{ location }}"></div>

    <!-- UI Overlay (top right) -->
    <div id="ui-overlay">
        <button id="help-btn" title="Help"><i class="fas fa-question-circle"></i></button>
        <button id="hint-btn" title="Hint"><i class="fas fa-lightbulb"></i></button>
        <div id="dropdown-menu" class="dropdown-menu hidden">
            <div class="menu-item" id="interview-btn"><i class="fas fa-user-friends"></i> Interview</div>
            <div class="menu-item" id="scan-btn"><i class="fas fa-search"></i> Evidence Scanner</div>
            <div class="menu-item" id="analyze-btn"><i class="fas fa-microscope"></i> Digital Analysis</div>
            <div class="menu-item" id="notes-btn"><i class="fas fa-sticky-note"></i> Notes</div>
        </div>
        <button id="hamburger-menu" class="hamburger-menu" title="Tools"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Storyboard/Dialogue Section -->
    <div class="dialogue-overlay">
        <div class="dialogue-container">
            <div class="dialogue-portrait-section">
                <div class="npc-portrait-frame">
                    <div id="speaker-npc" class="npc-portrait"></div>
                </div>
                <div class="npc-name-plate" id="npc-name">SECTOR-9 Command</div>
            </div>
            <div class="dialogue-box">
                <div class="dialogue-text-area" id="dialogue-text">Investigation ongoing. Use the menu for additional tools.</div>
                <div class="dialogue-choices" id="dialogue-choices"></div>
                <button class="dialogue-continue hidden" id="dialogue-continue">Continue</button>
            </div>
        </div>
    </div>

    <!-- Tools & Inventory Sidebar (hidden by default, toggled by hamburger-menu) -->
    <div id="tool-sidebar" class="tool-sidebar hidden">
        <h3>üõ†Ô∏è Tools</h3>
        <ul id="tool-list">
            {% for tool in tools %}
            <li class="tool-item">{{ tool }}</li>
            {% endfor %}
        </ul>
        <h4>Equipped:</h4>
        <div id="equipped-tool">None</div>
    </div>

    <!-- Objectives Panel -->
    <div class="objectives-panel">
        <h3>Objectives</h3>
        <ul class="objectives-list" id="objectives-list">
            {% for obj in objectives %}
            <li data-index="{{ loop.index0 }}">
                <span class="objective-status">[ ]</span> {{ obj }}
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Modal for Tools -->
    <div id="tool-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-modal" class="modal-close">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span id="help-close" class="modal-close">&times;</span>
            <h2>Investigation Help</h2>
            <p>Use the menu to interview NPCs, scan for evidence, analyze digital clues, and take notes. Complete all objectives to finish the investigation.</p>
        </div>
    </div>

    <!-- Hint Box -->
    <div id="hint-box" class="modal hidden">
        <div class="modal-content">
            <h2>Hint</h2>
            <div id="hint-content"></div>
        </div>
    </div>

    <!-- Achievements Modal Trigger Button -->
    <button id="show-achievements-btn">Achievements</button>

    <!-- Achievements Modal -->
    <div id="achievements-modal">
        <h2>Achievements</h2>
        <div id="achievements-list"></div>
        <button id="close-achievements-btn">Close</button>
    </div>

    <div id="popup-notification" class="popup-notification hidden"></div>

    <div class="investigation-header">
        <h1>{{ meta.title }}</h1>
        <div class="investigation-meta">
            <span class="meta-label">Time Limit:</span>
            <span class="meta-value">
                {% if meta.timeLimit %}
                    {% set minutes = meta.timeLimit // 60 %}
                    {% set seconds = meta.timeLimit % 60 %}
                    {{ '%02d:%02d' % (minutes, seconds) }}
                {% else %}
                    --:--
                {% endif %}
            </span>
        </div>
    </div>
</div>

<!-- Store template data in a hidden element -->
<div id="template-data" 
    data-objectives="{{ objectives|tojson|safe }}"
    data-tools="{{ tools|tojson|safe }}"
    data-location="{{ location }}">
</div>

<!-- External Scripts -->
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level1.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level2.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level3.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level4.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level5.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level6.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level7.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level8.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level9.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='dialogues/level10.js') }}"></script>

<!-- Initialize game data -->
<script nonce="{{ csp_nonce }}">
    // Get data from template
    const templateData = document.getElementById('template-data');
    window.objectives = JSON.parse(templateData.dataset.objectives);
    window.tools = JSON.parse(templateData.dataset.tools);
    window.currentLocation = templateData.dataset.location;
</script>

<!-- Main game script -->
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='js/investigation.js') }}" defer></script>
{% endblock content %}

{% block extra_scripts %}{% endblock extra_scripts %} 