{% extends "base.html" %}
{% block title %}Investigation - {{ location_name }}{% endblock %}

{% block content %}
<div class="investigation-container">
    <!-- Location Background -->
    <div class="location-background" style="background-image: url('/static/images/backgrounds/{{ location }}.png');">
        
        <!-- Simple Header -->
        <div class="investigation-header">
            <h2>{{ location_name }}</h2>
            <div class="agent-info">Agent {{ name }}</div>
        </div>

        <!-- Navigation (Top Right) -->
        <div class="investigation-nav">
            <a href="/mission/{{ location }}" class="nav-link">
                <i class="fas fa-file-alt"></i>
                Briefing
            </a>
            <a href="/game" class="nav-link">
                <i class="fas fa-map"></i>
                Map
            </a>
        </div>

        <!-- Player Avatar (Bottom Left) -->
        <div id="player-avatar" class="player-avatar">
            {% if avatar_parts %}
                {% for category, part in avatar_parts.items() %}
                    {% if category == 'characters' %}
                        <img class="avatar-layer" src="/static/images/avatar_parts/{{ category }}/{{ part.name if part is mapping else part }}.png" alt="{{ category }}">
                    {% else %}
                        {% set part_name = part.name if part is mapping else 'default' %}
                        {% set subcategory = part.subcategory if part is mapping else 'default' %}
                        <img class="avatar-layer" src="/static/images/avatar_parts/{{ category }}/{{ subcategory }}/{{ part_name }}.png" alt="{{ category }}">
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <!-- NPC Avatar (Bottom Right) -->
        <div id="npc-avatar" class="npc-avatar">
            <!-- Generated by JavaScript -->
        </div>

        <!-- Simple Toolbar (Bottom Center, Initially Hidden) -->
        <div class="simple-toolbar hidden" id="toolbar">
            <button class="tool-btn primary" id="interview-btn">
                <i class="fas fa-comments"></i>
                Interview
            </button>
            <button class="tool-btn" id="scan-btn">
                <i class="fas fa-search"></i>
                Scan
            </button>
            <button class="tool-btn" id="analyze-btn">
                <i class="fas fa-microscope"></i>
                Analyze
            </button>
            <button class="tool-btn" id="notes-btn">
                <i class="fas fa-sticky-note"></i>
                Notes
            </button>
        </div>

        <!-- Show Toolbar Button -->
        <button class="show-toolbar-btn" id="show-toolbar">
            <i class="fas fa-tools"></i>
            Investigation Tools
        </button>

        <!-- Dialogue Overlay -->
        <div id="dialogue-overlay" class="dialogue-overlay hidden">
            <div class="dialogue-container">
                <div class="dialogue-portrait-section">
                    <div class="npc-portrait-frame">
                        <div id="npc-portrait" class="npc-portrait"></div>
                    </div>
                    <div class="npc-name-plate">
                        <span id="npc-name">NPC Name</span>
                    </div>
                </div>
                
                <div class="dialogue-box">
                    <div class="dialogue-text-area">
                        <p id="dialogue-text"></p>
                    </div>
                    <div class="dialogue-choices" id="dialogue-choices">
                        <!-- Choice buttons will be added here -->
                    </div>
                    <div class="dialogue-continue hidden" id="dialogue-continue">
                        <span>Click to continue...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simple Modal for Tools -->
        <div id="tool-modal" class="tool-modal hidden">
            <div class="modal-content">
                <h3 id="modal-title">Tool Name</h3>
                <div id="modal-body">
                    <!-- Tool content here -->
                </div>
                <button class="close-modal" id="close-modal">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>

        <!-- Simple Progress Indicator -->
        <div class="progress-indicator" id="progress">
            <span id="progress-text">0/4 Objectives Complete</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple variables
let objectivesCompleted = 0;
let totalObjectives = 4;
const missionLocation = "{{ location }}";
const locationName = "{{ location_name }}";

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    generateNPC();
    startWelcome();
    setupSimpleEvents();
});

// Generate NPC
function generateNPC() {
    const npcAvatar = document.getElementById('npc-avatar');
    const avatarLayers = ['character', 'hair', 'clothes', 'face'];
    npcAvatar.innerHTML = '';
    
    avatarLayers.forEach(layer => {
        const img = document.createElement('img');
        img.className = 'avatar-layer';
        img.src = `/static/images/avatar_parts/${layer}/${getRandomVariant(layer)}.png`;
        img.onerror = function() { this.style.display = 'none'; };
        npcAvatar.appendChild(img);
    });
}

function getRandomVariant(layer) {
    const variants = {
        'character': ['character1', 'character2', 'character3'],
        'hair': ['hair1', 'hair2', 'hair3', 'hair4'],
        'clothes': ['clothes1', 'clothes2', 'clothes3', 'clothes4'],
        'face': ['face1', 'face2', 'face3']
    };
    const options = variants[layer] || ['default'];
    return options[Math.floor(Math.random() * options.length)];
}

// Simple welcome
function startWelcome() {
    setTimeout(() => {
        showDialogue('SECTOR-9 Command', `Agent, you've arrived at ${locationName}. Begin your investigation.`, [
            { text: "Roger that. Starting investigation.", action: () => showToolbar() }
        ]);
    }, 1000);
}

function showToolbar() {
    document.getElementById('show-toolbar').style.display = 'none';
    document.getElementById('toolbar').style.display = 'flex';
}

// Simple events
function setupSimpleEvents() {
    // Show toolbar button
    document.getElementById('show-toolbar').addEventListener('click', showToolbar);

    // Interview button
    document.getElementById('interview-btn').addEventListener('click', function() {
        startInterview();
    });

    // Scan button
    document.getElementById('scan-btn').addEventListener('click', function() {
        showToolModal('Evidence Scanner', `
            <button onclick="runScan()" class="action-btn">
                <i class="fas fa-search"></i> Run System Scan
            </button>
                            <div id="scan-result" class="result-container"></div>
        `);
    });

    // Analyze button
    document.getElementById('analyze-btn').addEventListener('click', function() {
        showToolModal('Digital Analysis', `
            <button onclick="runAnalysis()" class="action-btn">
                <i class="fas fa-microscope"></i> Analyze Evidence
            </button>
                            <div id="analysis-result" class="result-container"></div>
        `);
    });

    // Notes button
    document.getElementById('notes-btn').addEventListener('click', function() {
        const notes = localStorage.getItem('investigationNotes') || '';
        showToolModal('Mission Notes', `
            <textarea id="notes-text" placeholder="Record your findings..." class="notes-textarea">${notes}</textarea>
            <button onclick="saveNotes()" class="action-btn notes-save-btn">
                <i class="fas fa-save"></i> Save Notes
            </button>
        `);
    });

    // Close modal
    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('tool-modal').style.display = 'none';
    });
}

// Tool functions
function runScan() {
    completeObjective();
    document.getElementById('scan-result').innerHTML = `
                        <div class="success-message">
            <strong>Scan Complete:</strong> Suspicious files detected in system directory.
        </div>
    `;
}

function runAnalysis() {
    completeObjective();
    document.getElementById('analysis-result').innerHTML = `
                        <div class="warning-message">
            <strong>Analysis Complete:</strong> Malware signatures found. Attack vector identified.
        </div>
    `;
}

function saveNotes() {
    const notes = document.getElementById('notes-text').value;
    localStorage.setItem('investigationNotes', notes);
    showToast('Notes saved!');
}

function completeObjective() {
    objectivesCompleted = Math.min(objectivesCompleted + 1, totalObjectives);
    document.getElementById('progress-text').textContent = `${objectivesCompleted}/${totalObjectives} Objectives Complete`;
    showToast('Objective completed!');
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: #28a745; color: white; padding: 12px 24px; border-radius: 8px;
        z-index: 9999; font-family: 'Share Tech Mono', monospace;
        animation: fadeInOut 3s ease-in-out;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showToolModal(title, content) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = content;
    document.getElementById('tool-modal').style.display = 'flex';
}

// Interview system
function startInterview() {
    const levelKey = getDialogueLevelKey(missionLocation);
    
    if (window.missionDialogues && window.missionDialogues[levelKey]) {
        const dialogues = window.missionDialogues[levelKey];
        const npcNames = Object.keys(dialogues);
        
        if (npcNames.length === 1) {
            const npcName = npcNames[0];
            const npcDialogue = dialogues[npcName];
            showDialogue(npcName, npcDialogue.text, npcDialogue.choices);
        } else if (npcNames.length > 1) {
            const choices = npcNames.map(npcName => ({
                text: `Talk to ${npcName}`,
                nextDialogue: {
                    npc: npcName,
                    text: dialogues[npcName].text,
                    choices: dialogues[npcName].choices
                }
            }));
            showDialogue('Contact Selection', 'Who would you like to interview?', choices);
        } else {
            showDialogue('No Contacts', 'No contacts available at this location.', []);
        }
    } else {
        showDialogue('Local Contact', `Welcome to ${locationName}. The situation is critical.`, [
            { text: "I'll investigate immediately.", choices: [] }
        ]);
    }
}

// Dialogue functions
function showDialogue(npcName, dialogueText, choices = []) {
    const overlay = document.getElementById('dialogue-overlay');
    const npcNameEl = document.getElementById('npc-name');
    const dialogueTextEl = document.getElementById('dialogue-text');
    const choicesContainer = document.getElementById('dialogue-choices');
    const continueEl = document.getElementById('dialogue-continue');
    
    npcNameEl.textContent = npcName;
    typeText(dialogueText, dialogueTextEl);
    generateDialoguePortrait(npcName);
    
    choicesContainer.innerHTML = '';
    
    if (choices.length > 0) {
        continueEl.style.display = 'none';
        choices.forEach((choice, index) => {
            const choiceBtn = document.createElement('button');
            choiceBtn.className = 'dialogue-choice-btn';
            choiceBtn.textContent = choice.text;
            choiceBtn.addEventListener('click', () => {
                if (choice.action) choice.action();
                if (choice.nextDialogue) {
                    showDialogue(choice.nextDialogue.npc, choice.nextDialogue.text, choice.nextDialogue.choices);
                } else {
                    hideDialogue();
                }
            });
            choicesContainer.appendChild(choiceBtn);
        });
    } else {
        continueEl.style.display = 'block';
        continueEl.onclick = hideDialogue;
    }
    
    overlay.style.display = 'flex';
}

function hideDialogue() {
    document.getElementById('dialogue-overlay').style.display = 'none';
}

function typeText(text, element) {
    element.textContent = '';
    let i = 0;
    const timer = setInterval(() => {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
        } else {
            clearInterval(timer);
        }
    }, 30);
}

function generateDialoguePortrait(npcName) {
    const portraitEl = document.getElementById('npc-portrait');
    const avatarLayers = ['character', 'hair', 'clothes', 'face'];
    portraitEl.innerHTML = '';
    
    avatarLayers.forEach(layer => {
        const img = document.createElement('img');
        img.className = 'avatar-layer';
        img.src = `/static/images/avatar_parts/${layer}/${getRandomVariant(layer)}.png`;
        img.onerror = function() { this.style.display = 'none'; };
        portraitEl.appendChild(img);
    });
}

// Location mapping
function getDialogueLevelKey(location) {
    const locationToLevel = {
        'company': 'level1',
        'news': 'level2', 
        'bank': 'level3',
        'school': 'level6',
        'cafe': 'level4',
        'transport': 'level5',
        'hospital': 'level8',
        'government': 'level7',
        'hq': 'level9',
        'global': 'level10'
    };
    return locationToLevel[location] || 'level1';
}

// Global objective function for dialogues
window.markObjectiveComplete = function(index) {
    completeObjective();
};
</script>
<script src="{{ url_for('static', filename='js/dialogues.js') }}"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/investigation.css') }}">
{% endblock %} 