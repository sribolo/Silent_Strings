{% extends "base.html" %}
{% block title %}Main Game{% endblock %}
{% block extra_css %}
  <!-- Only style.css is needed now -->
{% endblock %}
{% block content %}
<div class="game-viewport">
  <div id="game-map">
    <img id="map-bg" src="{{ url_for('static', filename='images/pixel_town_1280x720.png') }}" alt="Town Map">
    
    <!-- PLAYER AVATAR (ALWAYS ON TOP OF MAP, NOT OVERLAY) -->
    <div id="player-avatar" class="avatar">
      {% set LAYER_ORDER = ["characters", "clothes", "hair", "face", "acc"] %}
    {% for part in LAYER_ORDER %}
      {% set value = avatar_parts.get(part) %}
      {% if value %}
        {% if part == "characters" %}
          <img src="{{ url_for('static', filename='images/avatar_parts/characters/' + (value.name if value is mapping and value.name else value|string) + '.png') }}"
              alt="{{ part }}" class="avatar-layer">
        {% elif part in ["clothes", "hair", "face", "acc"] and value is mapping %}
          {% for subcat, item in value.items() %}
            {% if item.name %}
              {% if part == "acc" %}
                <img src="{{ url_for('static', filename='images/avatar_parts/acc/' + item.name + '.png') }}"
                    alt="{{ subcat }}" class="avatar-layer">
              {% else %}
                <img src="{{ url_for('static', filename='images/avatar_parts/' + part + '/' + (item.subcategory or subcat) + '/' + item.name + '.png') }}"
                    alt="{{ subcat }}" class="avatar-layer">
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}
    {% endfor %}

    </div>
    


    <!-- MAP BUILDING BUTTONS (STILL ON MAP, NOT OVERLAY) -->
    <button class="map-area-btn map-area-bank{% if 'level3' in completed_missions %} completed{% endif %}" data-mission="level3" title="PhishNet - Bank Investigation{% if 'level3' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-school{% if 'level6' in completed_missions %} completed{% endif %}" data-mission="level6" title="School Network Breach - Riverside Academy{% if 'level6' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-company{% if 'level4' in completed_missions %} completed{% endif %}" data-mission="level4" title="Shadow Repo - Software Company{% if 'level4' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-cafe{% if 'level7' in completed_missions %} completed{% endif %}" data-mission="level7" title="Crypto CafÃ© Heist - BitBean Coffee Shop{% if 'level7' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-news{% if 'level2' in completed_missions %} completed{% endif %}" data-mission="level2" title="Operation Deadlink - News Outlet{% if 'level2' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-government{% if 'level5' in completed_missions %} completed{% endif %}" data-mission="level5" title="Trojan Trap - Government Server{% if 'level5' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-transport{% if 'level9' in completed_missions %} completed{% endif %}" data-mission="level9" title="Silent Rails: Transit Hijack - Metro Authority{% if 'level9' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-hq{% if 'level1' in completed_missions %} completed{% endif %}" data-mission="level1" title="Breach at Base - SECTOR-9 HQ{% if 'level1' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    <button class="map-area-btn map-area-hospital{% if 'level8' in completed_missions %} completed{% endif %}" data-mission="level8" title="Code Blue: Hospital Ransomware - Central Medical{% if 'level8' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    
    <!-- Final level - only show if all others completed -->
    {% if level10_unlocked %}
    <button class="map-area-btn map-area-global{% if 'level10' in completed_missions %} completed{% endif %} unlocked" data-mission="level10" title="Final String - Global Network{% if 'level10' in completed_missions %} âœ… COMPLETED{% endif %}"></button>
    {% else %}
    <div class="map-area-locked" title="ðŸ”’ Complete all 9 missions to unlock the Final String">ðŸ”’</div>
    {% endif %}
    
    <!-- OVERLAY: TOP-RIGHT CORNER ONLY, FLOATS ABOVE MAP, NEVER MOVES -->
    <div id="ui-overlay">
      <a href="{{ url_for('profile') }}" id="profile-btn" title="Your Profile">
        <img src="{{ url_for('static', filename='images/profile.png') }}" alt="Profile" class="profile-icon">
      </a>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='js/game.js') }}"></script>
{% endblock %}
